using System;
using System.Speech.Recognition;
using System.Windows.Forms;

namespace StartForm {
    /// <summary>
    /// Represents the starting login/signup window.
    /// </summary>
    public partial class Start : Form {
        /// <summary>
        /// Represents an in-process speech recognition engine and provides the means to access and manage it.
        /// </summary>
        public SpeechRecognitionEngine SREngine;

        /// <summary>
        /// Initializes a new start window.
        /// </summary>
        public Start()
        {
            InitializeComponent();
            SetupSpeechRecognition();

            StartPosition = FormStartPosition.CenterScreen;
        }

        /// <summary>
        /// Sets up SREngine and its grammers for voice commands. Called in the constructor.
        /// </summary>
        private void SetupSpeechRecognition()
        {
            SREngine = new SpeechRecognitionEngine();
            SREngine.SetInputToDefaultAudioDevice();

            var login = new Grammar(new Choices("log in", "login", "log me in")) { Name = "login" };
            SREngine.LoadGrammar(login);

            var signup = new Grammar(new Choices("sign up", "signup", "sign me up")) { Name = "signup" };
            SREngine.LoadGrammar(signup);

            var exit = new Grammar(new Choices("exit", "quit", "close")) { Name = "exit" };
            SREngine.LoadGrammar(exit);

            var help = new Grammar(new Choices("help", "help me")) { Name = "help" };
            SREngine.LoadGrammar(help);

            var secret = new Grammar(new GrammarBuilder("password")) { Name = "secret" };
            SREngine.LoadGrammar(secret);

            SREngine.SpeechRecognized += SREngine_SpeechRecognized;
            SREngine.RecognizeAsync(RecognizeMode.Multiple);
        }

        // Checks which grammer got recognised and executes the related command.
        private void SREngine_SpeechRecognized(object sender, SpeechRecognizedEventArgs e)
        {
            switch ( e.Result.Grammar.Name ) {
                case "login":
                    B_Login.PerformClick();
                    break;
                case "signup":
                    B_Signup.PerformClick();
                    break;
                case "exit":
                    B_Exit.PerformClick();
                    break;
                case "help":
                    Help.ShowPopup(this, "Help For Voice Control\n\nSay 'Log (me) in' to login.\nSay 'Sign (me) up' to signup.\n\nYou have been helped.", Location);
                    break;
                case "secret":
                    System.Diagnostics.Process.Start("explorer", "http://youtu.be/dQw4w9WgXcQ");
                    break;
                default:
                    throw new Exception($"WHAT: {e.Result.Grammar.Name}, {e.Result.Text}");//tmp
            }
        }

        /// <summary>
        /// Starts the malware.
        /// </summary>
        private void Login()
        {
            // Must cancel and remove event so Joke can use SREngine.
            SREngine.RecognizeAsyncCancel();
            SREngine.SpeechRecognized -= SREngine_SpeechRecognized;

            MessageBox.Show("Logging you in...");

            Hide();
            notifyIconJ.Visible = true; // used in Joke

            Joke joke = new Joke(this);
            joke.Run();
        }

        // Logs user in if the inputted username and password are legitimate.
        private void B_Login_Click(object sender, EventArgs e)
        {
            if ( string.IsNullOrWhiteSpace(TB_Name.Text) || string.IsNullOrWhiteSpace(TB_Password.Text) ) {
                MessageBox.Show("Text boxes cannot be empty.", "Invaild Input", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            bool isCorrect = SqlHelper.CheckUser(TB_Name.Text, TB_Password.Text);

            if ( isCorrect ) {
                Login();
            }
            else {
                MessageBox.Show("Inncorect username or password", " !", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // Signs user up if username and password input is valid and then logs in.
        private void B_Signup_Click(object sender, EventArgs e)
        {
            if ( string.IsNullOrWhiteSpace(TB_Name.Text) || string.IsNullOrWhiteSpace(TB_Password.Text) ) {
                MessageBox.Show("Text boxes cannot be empty.", "Invaild Input", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            bool isSuccessful = SqlHelper.SaveUser(TB_Name.Text, TB_Password.Text);

            if ( isSuccessful ) {
                Login();
            }
            else {
                MessageBox.Show("Username already taken.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // No exit is permitted.
        private void B_Exit_Click(object sender, EventArgs e)
        {
            MessageBox.Show("You cannot close this.");
        }
    }
}
